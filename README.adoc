= Backend

* https://learn.microsoft.com/en-us/aspnet/core/tutorials/first-web-api?view=aspnetcore-6.0&tabs=visual-studio#install-http-repl
+
[source,powershell]
----
dotnet tool install -g Microsoft.dotnet-httprepl
----

* https://learn.microsoft.com/en-us/aspnet/core/tutorials/first-web-api?view=aspnetcore-6.0&tabs=visual-studio#test-posttodoitem-1
+
fix, use 7020 not 5001 (as per launch settings)
+
[source,powershell]
----
httprepl https://localhost:7020/api/todoitems
----
+then
+
[source,repl]
----
post -h Content-Type=application/json -c "{"name":"walk dog","isComplete":true}"
----


== Experimenting with the repl and swagger

* re-enabled Swagger in `Program.cs`

* connect using just:
+
[source,powershell]
----
httprepl https://localhost:7020/
----
+
[source,output]
----
❯ httprepl https://localhost:7020/
(Disconnected)> connect https://localhost:7020/
Using a base address of https://localhost:7020/
Using OpenAPI description at https://localhost:7020/swagger/v1/swagger.json
For detailed tool info, see https://aka.ms/http-repl-doc

https://localhost:7020/>
----

* can cd, ls, post, get etc
+
[source,repl]
----
cd api/TodoItems
post -h Content-Type=application/json -c "{"name":"walk dog","isComplete":true}"
----
+
[source,output]
----
HTTP/1.1 201 Created
Content-Type: application/json; charset=utf-8
Date: Sat, 19 Nov 2022 10:34:03 GMT
Location: https://localhost:7020/api/TodoItems/2
Server: Kestrel
Transfer-Encoding: chunked

{
  "id": 1,
  "name": "walk dog",
  "isComplete": true
}
----

== Generate Swagger file at  built time

as per https://github.com/domaindrivendev/Swashbuckle.AspNetCore#using-the-tool-with-the-net-core-30-sdk-or-later

[source,powershell]
----
cd backend\TodoApi\TodoApi
dotnet new tool-manifest
dotnet tool install --version 6.2.3 Swashbuckle.AspNetCore.Cli      #<.>
----
<.> important to use the same version as in the app itself.

* generate with:
+
[source,powershell]
----
dotnet swagger tofile --output x.json bin\Debug\net6.0\TodoApi.dll v1
----

and adding as a PostBuild target means will be generated each time.



== Reorganised ...

renamed solution, backend proj.


== Razor MVC tutorial

as per previous commit messages...

in Package Manager console:

* create migrations
+
[source,pm]
----
PM> Add-Migration InitialCreate
----
+
results in:
+
[source,pm]
----
Build started...
Build succeeded.
Microsoft.EntityFrameworkCore.Model.Validation[30000]
No store type was specified for the decimal property 'Price' on entity type 'Movie'. This will cause values to be silently truncated if they do not fit in the default precision and scale. Explicitly specify the SQL server column type that can accommodate all the values in 'OnModelCreating' using 'HasColumnType', specify precision and scale using 'HasPrecision', or configure a value converter using 'HasConversion'.
Microsoft.EntityFrameworkCore.Infrastructure[10403]
Entity Framework Core 6.0.10 initialized 'RazorPagesMovieContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:6.0.10' with options: None
Microsoft.EntityFrameworkCore.Model.Validation[30000]
No store type was specified for the decimal property 'Price' on entity type 'Movie'. This will cause values to be silently truncated if they do not fit in the default precision and scale. Explicitly specify the SQL server column type that can accommodate all the values in 'OnModelCreating' using 'HasColumnType', specify precision and scale using 'HasPrecision', or configure a value converter using 'HasConversion'.
No store type was specified for the decimal property 'Price' on entity type 'Movie'. This will cause values to be silently truncated if they do not fit in the default precision and scale. Explicitly specify the SQL server column type that can accommodate all the values in 'OnModelCreating' using 'HasColumnType', specify precision and scale using 'HasPrecision', or configure a value converter using 'HasConversion'.
To undo this action, use Remove-Migration.
----

* apply the migrations
+
[source,pm]
----
PM> Update-Database
----
+
results in:
+
[source,pm]
----
Build started...
Build succeeded.
Microsoft.EntityFrameworkCore.Model.Validation[30000]
      No store type was specified for the decimal property 'Price' on entity type 'Movie'. This will cause values to be silently truncated if they do not fit in the default precision and scale. Explicitly specify the SQL server column type that can accommodate all the values in 'OnModelCreating' using 'HasColumnType', specify precision and scale using 'HasPrecision', or configure a value converter using 'HasConversion'.
Microsoft.EntityFrameworkCore.Infrastructure[10403]
      Entity Framework Core 6.0.10 initialized 'RazorPagesMovieContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer:6.0.10' with options: None
Microsoft.EntityFrameworkCore.Model.Validation[30000]
      No store type was specified for the decimal property 'Price' on entity type 'Movie'. This will cause values to be silently truncated if they do not fit in the default precision and scale. Explicitly specify the SQL server column type that can accommodate all the values in 'OnModelCreating' using 'HasColumnType', specify precision and scale using 'HasPrecision', or configure a value converter using 'HasConversion'.
No store type was specified for the decimal property 'Price' on entity type 'Movie'. This will cause values to be silently truncated if they do not fit in the default precision and scale. Explicitly specify the SQL server column type that can accommodate all the values in 'OnModelCreating' using 'HasColumnType', specify precision and scale using 'HasPrecision', or configure a value converter using 'HasConversion'.
Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (181ms) [Parameters=[], CommandType='Text', CommandTimeout='60']
      CREATE DATABASE [RazorPagesMovie.Data];
Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (74ms) [Parameters=[], CommandType='Text', CommandTimeout='60']
      IF SERVERPROPERTY('EngineEdition') <> 5
      BEGIN
          ALTER DATABASE [RazorPagesMovie.Data] SET READ_COMMITTED_SNAPSHOT ON;
      END;
Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (5ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT 1
Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (6ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      CREATE TABLE [__EFMigrationsHistory] (
          [MigrationId] nvarchar(150) NOT NULL,
          [ProductVersion] nvarchar(32) NOT NULL,
          CONSTRAINT [PK___EFMigrationsHistory] PRIMARY KEY ([MigrationId])
      );
Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (0ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT 1
Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (10ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT OBJECT_ID(N'[__EFMigrationsHistory]');
Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (3ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      SELECT [MigrationId], [ProductVersion]
      FROM [__EFMigrationsHistory]
      ORDER BY [MigrationId];
Microsoft.EntityFrameworkCore.Migrations[20402]
      Applying migration '20221119115856_InitialCreate'.
Applying migration '20221119115856_InitialCreate'.
Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (2ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      CREATE TABLE [Movie] (
          [ID] int NOT NULL IDENTITY,
          [Title] nvarchar(max) NOT NULL,
          [ReleaseDate] datetime2 NOT NULL,
          [Genre] nvarchar(max) NOT NULL,
          [Price] decimal(18,2) NOT NULL,
          CONSTRAINT [PK_Movie] PRIMARY KEY ([ID])
      );
Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (1ms) [Parameters=[], CommandType='Text', CommandTimeout='30']
      INSERT INTO [__EFMigrationsHistory] ([MigrationId], [ProductVersion])
      VALUES (N'20221119115856_InitialCreate', N'6.0.10');
Done.
----

* which database did we insert into?
+
[source,json]
.appsettings.json
----
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "RazorPagesMovieContext": "Server=(localdb)\\mssqllocaldb;Database=RazorPagesMovie.Data;Trusted_Connection=True;MultipleActiveResultSets=true"
  }
}
----

* can connect to with SQL Server, disgustingly has used home directory for its files:
+
image::images/image-2022-11-19-12-13-14-331.png[width=600px]

Can also access from Visual Studio 2022, `View > SQL Server Object Explorer`.

